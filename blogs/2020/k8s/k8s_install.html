<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>K8S环境搭建 | 艺术码农的小栈</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="IT是一门艺术">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.33ec4896.css" as="style"><link rel="preload" href="/assets/js/app.26b7b206.js" as="script"><link rel="preload" href="/assets/js/4.34a1f699.js" as="script"><link rel="preload" href="/assets/js/1.fa01cbc2.js" as="script"><link rel="preload" href="/assets/js/50.ce1e315b.js" as="script"><link rel="prefetch" href="/assets/js/10.a1e795ad.js"><link rel="prefetch" href="/assets/js/11.f31056c6.js"><link rel="prefetch" href="/assets/js/12.b1eb3e6b.js"><link rel="prefetch" href="/assets/js/13.c4103c4c.js"><link rel="prefetch" href="/assets/js/14.528f041b.js"><link rel="prefetch" href="/assets/js/15.fb7c17bd.js"><link rel="prefetch" href="/assets/js/16.98c5f335.js"><link rel="prefetch" href="/assets/js/17.e12e3b8c.js"><link rel="prefetch" href="/assets/js/18.7e23d69f.js"><link rel="prefetch" href="/assets/js/19.4e6e4ff3.js"><link rel="prefetch" href="/assets/js/20.ecb8a1dc.js"><link rel="prefetch" href="/assets/js/21.fbb4f60e.js"><link rel="prefetch" href="/assets/js/22.6ed3ace2.js"><link rel="prefetch" href="/assets/js/23.21b67b7b.js"><link rel="prefetch" href="/assets/js/24.3560b691.js"><link rel="prefetch" href="/assets/js/25.977944c8.js"><link rel="prefetch" href="/assets/js/26.ae364031.js"><link rel="prefetch" href="/assets/js/27.abd90669.js"><link rel="prefetch" href="/assets/js/28.66696cc6.js"><link rel="prefetch" href="/assets/js/29.7b8fcf5f.js"><link rel="prefetch" href="/assets/js/3.14088b1f.js"><link rel="prefetch" href="/assets/js/30.18933227.js"><link rel="prefetch" href="/assets/js/31.bddcef69.js"><link rel="prefetch" href="/assets/js/32.eac5c260.js"><link rel="prefetch" href="/assets/js/33.57270104.js"><link rel="prefetch" href="/assets/js/34.ff0b3fbd.js"><link rel="prefetch" href="/assets/js/35.3f118186.js"><link rel="prefetch" href="/assets/js/36.5b32678d.js"><link rel="prefetch" href="/assets/js/37.8bdc3852.js"><link rel="prefetch" href="/assets/js/38.1c416da5.js"><link rel="prefetch" href="/assets/js/39.66ab3b68.js"><link rel="prefetch" href="/assets/js/40.24b0eb4f.js"><link rel="prefetch" href="/assets/js/41.d8a9d8cd.js"><link rel="prefetch" href="/assets/js/42.7552d30b.js"><link rel="prefetch" href="/assets/js/43.acf26f99.js"><link rel="prefetch" href="/assets/js/44.c7588fd9.js"><link rel="prefetch" href="/assets/js/45.111f27e2.js"><link rel="prefetch" href="/assets/js/46.3450f7a7.js"><link rel="prefetch" href="/assets/js/47.6856be26.js"><link rel="prefetch" href="/assets/js/48.8febc898.js"><link rel="prefetch" href="/assets/js/49.0408eb3f.js"><link rel="prefetch" href="/assets/js/5.f8b726c1.js"><link rel="prefetch" href="/assets/js/51.4cec59d7.js"><link rel="prefetch" href="/assets/js/52.7f11a198.js"><link rel="prefetch" href="/assets/js/53.61242f1b.js"><link rel="prefetch" href="/assets/js/54.d1f179eb.js"><link rel="prefetch" href="/assets/js/55.7da8ef79.js"><link rel="prefetch" href="/assets/js/56.2fb16d8d.js"><link rel="prefetch" href="/assets/js/57.169e1575.js"><link rel="prefetch" href="/assets/js/58.95211ddc.js"><link rel="prefetch" href="/assets/js/59.8389c0c4.js"><link rel="prefetch" href="/assets/js/6.be26a4fd.js"><link rel="prefetch" href="/assets/js/60.dbca9aae.js"><link rel="prefetch" href="/assets/js/61.e1143c0a.js"><link rel="prefetch" href="/assets/js/62.f3f7add9.js"><link rel="prefetch" href="/assets/js/63.328ca412.js"><link rel="prefetch" href="/assets/js/64.a0416026.js"><link rel="prefetch" href="/assets/js/65.6b761eca.js"><link rel="prefetch" href="/assets/js/66.7c071d8b.js"><link rel="prefetch" href="/assets/js/67.5e297bf1.js"><link rel="prefetch" href="/assets/js/68.685c6dd4.js"><link rel="prefetch" href="/assets/js/69.b90973ab.js"><link rel="prefetch" href="/assets/js/7.6051ac3d.js"><link rel="prefetch" href="/assets/js/70.7948ee53.js"><link rel="prefetch" href="/assets/js/71.800033d5.js"><link rel="prefetch" href="/assets/js/72.5ed4310b.js"><link rel="prefetch" href="/assets/js/73.2367d439.js"><link rel="prefetch" href="/assets/js/74.26f08eca.js"><link rel="prefetch" href="/assets/js/75.65f5b3d3.js"><link rel="prefetch" href="/assets/js/76.db8b2024.js"><link rel="prefetch" href="/assets/js/77.fc412538.js"><link rel="prefetch" href="/assets/js/78.92b44f25.js"><link rel="prefetch" href="/assets/js/79.b10bae1e.js"><link rel="prefetch" href="/assets/js/8.76fd16fb.js"><link rel="prefetch" href="/assets/js/80.742d6ecd.js"><link rel="prefetch" href="/assets/js/81.76a1d778.js"><link rel="prefetch" href="/assets/js/82.0301eeb7.js"><link rel="prefetch" href="/assets/js/83.a4ae9472.js"><link rel="prefetch" href="/assets/js/84.fe82531d.js"><link rel="prefetch" href="/assets/js/85.5ed6d46d.js"><link rel="prefetch" href="/assets/js/86.bf719bcc.js"><link rel="prefetch" href="/assets/js/87.3f96dc56.js"><link rel="prefetch" href="/assets/js/88.148a861c.js"><link rel="prefetch" href="/assets/js/89.acc39148.js"><link rel="prefetch" href="/assets/js/9.842229ff.js"><link rel="prefetch" href="/assets/js/90.e98d95a2.js"><link rel="prefetch" href="/assets/js/91.44e60548.js"><link rel="prefetch" href="/assets/js/92.55a62ae6.js"><link rel="prefetch" href="/assets/js/93.300f0878.js"><link rel="prefetch" href="/assets/js/94.7c7423e2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.33ec4896.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>艺术码农的小栈</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc>IT是一门艺术</p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>Hyman</span>
            
          <span data-v-4e82dffc>2009 - </span>
          2025
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="艺术码农的小栈" class="logo"> <span class="site-name">艺术码农的小栈</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      随手笔记
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/实践总结/" class="nav-link"><i class="undefined"></i>
  实践总结
</a></li><li class="dropdown-item"><!----> <a href="/categories/K8S/" class="nav-link"><i class="undefined"></i>
  K8S
</a></li><li class="dropdown-item"><!----> <a href="/categories/笔记/" class="nav-link"><i class="undefined"></i>
  笔记
</a></li><li class="dropdown-item"><!----> <a href="/categories/探索/" class="nav-link"><i class="undefined"></i>
  探索
</a></li><li class="dropdown-item"><!----> <a href="/categories/转载/" class="nav-link"><i class="undefined"></i>
  转载
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      主页
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/itart-top" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/piaohai" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-csdn"></i>
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="/avatar.png" alt="author-avatar" class="personal-img" data-v-828910c6> <h3 class="name" data-v-828910c6>
    Hyman
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>84</h3> <h6 data-v-828910c6>文章</h6></div> <div data-v-828910c6><h3 data-v-828910c6>33</h3> <h6 data-v-828910c6>标签</h6></div></div> <ul class="social-links" data-v-828910c6></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      随手笔记
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/实践总结/" class="nav-link"><i class="undefined"></i>
  实践总结
</a></li><li class="dropdown-item"><!----> <a href="/categories/K8S/" class="nav-link"><i class="undefined"></i>
  K8S
</a></li><li class="dropdown-item"><!----> <a href="/categories/笔记/" class="nav-link"><i class="undefined"></i>
  笔记
</a></li><li class="dropdown-item"><!----> <a href="/categories/探索/" class="nav-link"><i class="undefined"></i>
  探索
</a></li><li class="dropdown-item"><!----> <a href="/categories/转载/" class="nav-link"><i class="undefined"></i>
  转载
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      主页
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/itart-top" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/piaohai" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-csdn"></i>
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>K8S环境搭建</h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>Hyman</span>
            
          <span data-v-4e82dffc>2009 - </span>
          2025
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">K8S环境搭建</h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>Hyman</span></i> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>2020/11/23</span></i> <!----> <i class="tags iconfont reco-tag" data-v-1ff7123e><span class="tag-item" data-v-1ff7123e>K8S</span><span class="tag-item" data-v-1ff7123e>K8S</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="机器规划"><a href="#机器规划" class="header-anchor">#</a> 机器规划</h2> <table><thead><tr><th>机器</th> <th>角色</th> <th>软件</th></tr></thead> <tbody><tr><td>192.168.1.5</td> <td>master</td> <td>docker,etcd,flanneld，kubelet,kube_proxy,kube-apiserver、kube-controller-manager、kube-scheduler</td></tr> <tr><td>192.168.1.9</td> <td>node</td> <td>docker,etcd,flanneld,kubelet,kube_proxy</td></tr> <tr><td>192.168.1.16</td> <td>node</td> <td>docker,etcd,flanneld,kubelet,kube_proxy</td></tr></tbody></table> <h2 id="环境准备"><a href="#环境准备" class="header-anchor">#</a> 环境准备</h2> <p>1.关闭防火墙（三台机器同时进行）：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl stop firewalld <span class="token operator">&amp;&amp;</span> systemctl disable firewalld
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>2.关闭SELINUX（三台机器同时进行）：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#将selinux改成disabled保存并退出</span>
<span class="token function">vi</span> /etc/selinux/config
<span class="token assign-left variable">SELINUX</span><span class="token operator">=</span>disabled
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>3.关闭Swap（三台机器同时进行）：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>swapoff -a <span class="token operator">&amp;&amp;</span> sysctl -w vm.swappiness<span class="token operator">=</span><span class="token number">0</span>
<span class="token comment">#将内容里面的UUID进行注释</span>
<span class="token function">vi</span> /etc/fstab
<span class="token comment">#UUID=75db221b-5797-4f81-ac79-d75622cdf625 /boot</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>4.安装Docker（三台机器同时进行）：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#运行该脚本就可以安装Docker18.09版本，若Docker版本太高，安装k8s会出现问题</span>
<span class="token comment">#!/bin/bash</span>
yum remove docker-*
yum update -y
yum <span class="token function">install</span> -y yum-utils   device-mapper-persistent-data   lvm2
yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
yum -y <span class="token function">install</span> docker-ce-18.09.0 docker-ce-cli-18.09.0
systemctl start docker
systemctl <span class="token builtin class-name">enable</span> docker
<span class="token builtin class-name">echo</span> <span class="token string">'{
&quot;registry-mirrors&quot;: [&quot;https://b24tskqv.mirror.aliyuncs.com&quot;]
}'</span> <span class="token operator">&gt;</span> /etc/docker/daemon.json
systemctl daemon-reload
systemctl restart docker
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>5.配置主机名和ip地址的对应关系：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vi</span> /etc/hosts
<span class="token comment">#在该文件中添加（三台机器一起添加）</span>
<span class="token number">192.168</span>.1.5 master
<span class="token number">192.168</span>.1.9 node1
<span class="token number">192.168</span>.1.16 node2
<span class="token function">vi</span> /etc/hostname
<span class="token comment">#配置主机名（分别添加）</span>
在192.168.1.5中添加master，并将之前的内容删除
在192.168.1.9中添加node1，并将之前的内容删除
在192.168.1.16中添加node2，并将之前的内容删除
<span class="token comment">#执行完之后进行重启</span>
<span class="token function">reboot</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>6.免密码登录（三台机器两两配置免密码登录）：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#三台机器一起执行</span>
ssh-keygen -t rsa
<span class="token comment">#上面这条命令生成公钥和私钥（一路执行回车）</span>
<span class="token comment">#将公钥拷贝给对方，实现免密码登录</span>
ssh-copy-id -i .ssh/id_rsa.pub root@master
ssh-copy-id -i .ssh/id_rsa.pub root@node1
ssh-copy-id -i .ssh/id_rsa.pub root@node2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>7.创建安装目录（三台机器同时执行）：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">mkdir</span> -p /k8s/etcd/<span class="token punctuation">{</span>bin,cfg,ssl<span class="token punctuation">}</span>
<span class="token function">mkdir</span> -p /k8s/kubernetes/<span class="token punctuation">{</span>bin,cfg,ssl<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>8.安装包的下载链接：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>Client Binaries
https://dl.k8s.io/v1.13.1/kubernetes-client-linux-amd64.tar.gz
Server Binaries
https://dl.k8s.io/v1.13.1/kubernetes-server-linux-amd64.tar.gz
Node Binaries
https://dl.k8s.io/v1.13.1/kubernetes-node-linux-amd64.tar.gz
etcd
https://github.com/etcd-io/etcd/releases/download/v3.3.10/etcd-v3.3.10-linux-amd64.tar.gz
flannel
https://github.com/coreos/flannel/releases/download/v0.10.0/flannel-v0.10.0-linux-amd64.tar.gz
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="安装kubernetes"><a href="#安装kubernetes" class="header-anchor">#</a> 安装kubernetes</h2> <h3 id="安装及配置cfssl"><a href="#安装及配置cfssl" class="header-anchor">#</a> 安装及配置CFSSL</h3> <p>（在master节点执行然后进行拷贝）：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">wget</span> https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
<span class="token function">wget</span> https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
<span class="token function">wget</span> https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64
<span class="token function">chmod</span> +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64
<span class="token function">mv</span> cfssl_linux-amd64 /usr/local/bin/cfssl
<span class="token function">mv</span> cfssljson_linux-amd64 /usr/local/bin/cfssljson
<span class="token function">mv</span> cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="创建认证证书"><a href="#创建认证证书" class="header-anchor">#</a> 创建认证证书:</h3> <h4 id="etcd"><a href="#etcd" class="header-anchor">#</a> ETCD</h4> <ul><li>创建 ETCD 证书</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">tee</span> ca-config.json</span>
{
  &quot;signing&quot;: {
    &quot;default&quot;: {
      &quot;expiry&quot;: &quot;87600h&quot;
    },
    &quot;profiles&quot;: {
      &quot;www&quot;: {
         &quot;expiry&quot;: &quot;87600h&quot;,
         &quot;usages&quot;: [
            &quot;signing&quot;,
            &quot;key encipherment&quot;,
            &quot;server auth&quot;,
            &quot;client auth&quot;
        ]
      }
    }
  }
}
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><ul><li>创建 ETCD CA 配置文件</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">tee</span> ca-csr.json</span>
{
    &quot;CN&quot;: &quot;etcd CA&quot;,
    &quot;key&quot;: {
        &quot;algo&quot;: &quot;rsa&quot;,
        &quot;size&quot;: 2048
    },
    &quot;names&quot;: [
        {
            &quot;C&quot;: &quot;CN&quot;,
            &quot;L&quot;: &quot;Shenzhen&quot;,
            &quot;ST&quot;: &quot;Shenzhen&quot;
        }
    ]
}
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ul><li>创建 ETCD Server 证书</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">tee</span> server-csr.json</span>
{
    &quot;CN&quot;: &quot;etcd&quot;,
    &quot;hosts&quot;: [
    &quot;192.168.1.5&quot;,
    &quot;192.168.1.9&quot;,
    &quot;192.168.1.16&quot;
    ],
    &quot;key&quot;: {
        &quot;algo&quot;: &quot;rsa&quot;,
        &quot;size&quot;: 2048
    },
    &quot;names&quot;: [
        {
            &quot;C&quot;: &quot;CN&quot;,
            &quot;L&quot;: &quot;Shenzhen&quot;,
            &quot;ST&quot;: &quot;Shenzhen&quot;
        }
    ]
}
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><ul><li>生成 ETCD CA 证书和私钥</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>cfssl gencert -initca ca-csr.json <span class="token operator">|</span> cfssljson -bare ca -
cfssl gencert -ca<span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem -config<span class="token operator">=</span>ca-config.json -profile<span class="token operator">=</span>www server-csr.json <span class="token operator">|</span> cfssljson -bare server
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="kubernetes"><a href="#kubernetes" class="header-anchor">#</a> Kubernetes</h4> <ul><li>创建 Kubernetes CA 证书</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">tee</span> ca-config.json</span>
{
  &quot;signing&quot;: {
    &quot;default&quot;: {
      &quot;expiry&quot;: &quot;87600h&quot;
    },
    &quot;profiles&quot;: {
      &quot;kubernetes&quot;: {
         &quot;expiry&quot;: &quot;87600h&quot;,
         &quot;usages&quot;: [
            &quot;signing&quot;,
            &quot;key encipherment&quot;,
            &quot;server auth&quot;,
            &quot;client auth&quot;
        ]
      }
    }
  }
}
EOF</span>
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">tee</span> ca-csr.json</span>
{
    &quot;CN&quot;: &quot;kubernetes&quot;,
    &quot;key&quot;: {
        &quot;algo&quot;: &quot;rsa&quot;,
        &quot;size&quot;: 2048
    },
    &quot;names&quot;: [
        {
            &quot;C&quot;: &quot;CN&quot;,
            &quot;L&quot;: &quot;Shenzhen&quot;,
            &quot;ST&quot;: &quot;Shenzhen&quot;,
            &quot;O&quot;: &quot;k8s&quot;,
            &quot;OU&quot;: &quot;System&quot;
        }
    ]
}
EOF</span>

cfssl gencert -initca ca-csr.json <span class="token operator">|</span> cfssljson -bare ca -
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><ul><li>生成API_SERVER证书</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">tee</span> server-csr.json</span>
{
    &quot;CN&quot;: &quot;kubernetes&quot;,
    &quot;hosts&quot;: [
      &quot;10.0.0.1&quot;,
      &quot;127.0.0.1&quot;,
      &quot;192.168.1.5&quot;,
      &quot;kubernetes&quot;,
      &quot;kubernetes.default&quot;,
      &quot;kubernetes.default.svc&quot;,
      &quot;kubernetes.default.svc.cluster&quot;,
      &quot;kubernetes.default.svc.cluster.local&quot;
    ],
    &quot;key&quot;: {
        &quot;algo&quot;: &quot;rsa&quot;,
        &quot;size&quot;: 2048
    },
    &quot;names&quot;: [
        {
            &quot;C&quot;: &quot;CN&quot;,
            &quot;L&quot;: &quot;Shenzhen&quot;,
            &quot;ST&quot;: &quot;Shenzhen&quot;,
            &quot;O&quot;: &quot;k8s&quot;,
            &quot;OU&quot;: &quot;System&quot;
        }
    ]
}
EOF</span>

cfssl gencert -ca<span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem -config<span class="token operator">=</span>ca-config.json -profile<span class="token operator">=</span>kubernetes server-csr.json <span class="token operator">|</span> cfssljson -bare server
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><ul><li>创建 Kubernetes Proxy 证书</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">tee</span> kube-proxy-csr.json</span>
{
  &quot;CN&quot;: &quot;system:kube-proxy&quot;,
  &quot;hosts&quot;: [],
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;L&quot;: &quot;Shenzhen&quot;,
      &quot;ST&quot;: &quot;Shenzhen&quot;,
      &quot;O&quot;: &quot;k8s&quot;,
      &quot;OU&quot;: &quot;System&quot;
    }
  ]
}
EOF</span>

cfssl gencert -ca<span class="token operator">=</span>ca.pem -ca-key<span class="token operator">=</span>ca-key.pem -config<span class="token operator">=</span>ca-config.json -profile<span class="token operator">=</span>kubernetes kube-proxy-csr.json <span class="token operator">|</span> cfssljson -bare kube-proxy
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="部署etcd"><a href="#部署etcd" class="header-anchor">#</a> 部署ETCD</h3> <ul><li>解压安装文件</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">tar</span> -xvf etcd-v3.3.10-linux-amd64.tar.gz
<span class="token builtin class-name">cd</span> etcd-v3.3.10-linux-amd64/
<span class="token function">cp</span> etcd etcdctl /k8s/etcd/bin/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>创建etcd配置文件</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /k8s/etcd/cfg/etcd

<span class="token comment">#[Member]</span>
<span class="token assign-left variable">ETCD_NAME</span><span class="token operator">=</span><span class="token string">&quot;etcd01&quot;</span>
<span class="token assign-left variable">ETCD_DATA_DIR</span><span class="token operator">=</span><span class="token string">&quot;/var/lib/etcd/default.etcd&quot;</span>
<span class="token assign-left variable">ETCD_LISTEN_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.1.5:2380&quot;</span>
<span class="token assign-left variable">ETCD_LISTEN_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.1.5:2379&quot;</span>

<span class="token comment">#[Clustering]</span>
<span class="token assign-left variable">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.1.5:2380&quot;</span>
<span class="token assign-left variable">ETCD_ADVERTISE_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.1.5:2379&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER</span><span class="token operator">=</span><span class="token string">&quot;etcd01=https://192.168.1.5:2380,etcd02=https://192.168.1.9:2380,etcd03=https://192.168.1.16:2380&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="token operator">=</span><span class="token string">&quot;etcd-cluster&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_STATE</span><span class="token operator">=</span><span class="token string">&quot;new&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><ul><li>创建 etcd的 systemd unit 文件</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /usr/lib/systemd/system/etcd.service

<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Etcd Server
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target
<span class="token assign-left variable">After</span><span class="token operator">=</span>network-online.target
<span class="token assign-left variable">Wants</span><span class="token operator">=</span>network-online.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>notify
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>/k8s/etcd/cfg/etcd
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/k8s/etcd/bin/etcd <span class="token punctuation">\</span>
--name<span class="token operator">=</span><span class="token variable">${ETCD_NAME}</span> <span class="token punctuation">\</span>
--data-dir<span class="token operator">=</span><span class="token variable">${ETCD_DATA_DIR}</span> <span class="token punctuation">\</span>
--listen-peer-urls<span class="token operator">=</span><span class="token variable">${ETCD_LISTEN_PEER_URLS}</span> <span class="token punctuation">\</span>
--listen-client-urls<span class="token operator">=</span><span class="token variable">${ETCD_LISTEN_CLIENT_URLS}</span>,http://127.0.0.1:2379 <span class="token punctuation">\</span>
--advertise-client-urls<span class="token operator">=</span><span class="token variable">${ETCD_ADVERTISE_CLIENT_URLS}</span> <span class="token punctuation">\</span>
--initial-advertise-peer-urls<span class="token operator">=</span><span class="token variable">${ETCD_INITIAL_ADVERTISE_PEER_URLS}</span> <span class="token punctuation">\</span>
--initial-cluster<span class="token operator">=</span><span class="token variable">${ETCD_INITIAL_CLUSTER}</span> <span class="token punctuation">\</span>
--initial-cluster-token<span class="token operator">=</span><span class="token variable">${ETCD_INITIAL_CLUSTER_TOKEN}</span> <span class="token punctuation">\</span>
--initial-cluster-state<span class="token operator">=</span>new <span class="token punctuation">\</span>
--cert-file<span class="token operator">=</span>/k8s/etcd/ssl/server.pem <span class="token punctuation">\</span>
--key-file<span class="token operator">=</span>/k8s/etcd/ssl/server-key.pem <span class="token punctuation">\</span>
--peer-cert-file<span class="token operator">=</span>/k8s/etcd/ssl/server.pem <span class="token punctuation">\</span>
--peer-key-file<span class="token operator">=</span>/k8s/etcd/ssl/server-key.pem <span class="token punctuation">\</span>
--trusted-ca-file<span class="token operator">=</span>/k8s/etcd/ssl/ca.pem <span class="token punctuation">\</span>
--peer-trusted-ca-file<span class="token operator">=</span>/k8s/etcd/ssl/ca.pem
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65536</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><ul><li>拷贝证书文件</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cp</span> ca*pem server*pem /k8s/etcd/ssl
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>启动ETCD服务</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> etcd
systemctl start etcd
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>将启动文件、配置文件拷贝到 节点1、节点2</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /k8s/
<span class="token function">scp</span> -r etcd node1:/k8s/
<span class="token function">scp</span> -r etcd node2:/k8s/
<span class="token function">scp</span> /usr/lib/systemd/system/etcd.service  node1:/usr/lib/systemd/system/etcd.service
<span class="token function">scp</span> /usr/lib/systemd/system/etcd.service  node2:/usr/lib/systemd/system/etcd.service

<span class="token comment">#在node1上面操作</span>
<span class="token function">vim</span> /k8s/etcd/cfg/etcd
<span class="token comment">#[Member]</span>
<span class="token assign-left variable">ETCD_NAME</span><span class="token operator">=</span><span class="token string">&quot;etcd02&quot;</span>
<span class="token assign-left variable">ETCD_DATA_DIR</span><span class="token operator">=</span><span class="token string">&quot;/var/lib/etcd/default.etcd&quot;</span>
<span class="token assign-left variable">ETCD_LISTEN_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.1.9:2380&quot;</span>
<span class="token assign-left variable">ETCD_LISTEN_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.1.9:2379&quot;</span>

<span class="token comment">#[Clustering]</span>
<span class="token assign-left variable">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.1.9:2380&quot;</span>
<span class="token assign-left variable">ETCD_ADVERTISE_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.1.9:2379&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER</span><span class="token operator">=</span><span class="token string">&quot;etcd01=https://192.168.1.5:2380,etcd02=https://192.168.1.9:2380,etcd03=https://192.168.1.16:2380&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="token operator">=</span><span class="token string">&quot;etcd-cluster&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_STATE</span><span class="token operator">=</span><span class="token string">&quot;new&quot;</span>

<span class="token comment">#在node2上面操作</span>
<span class="token function">vim</span> /k8s/etcd/cfg/etcd

<span class="token comment">#[Member]</span>
<span class="token assign-left variable">ETCD_NAME</span><span class="token operator">=</span><span class="token string">&quot;etcd03&quot;</span>
<span class="token assign-left variable">ETCD_DATA_DIR</span><span class="token operator">=</span><span class="token string">&quot;/var/lib/etcd/default.etcd&quot;</span>
<span class="token assign-left variable">ETCD_LISTEN_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.1.16:2380&quot;</span>
<span class="token assign-left variable">ETCD_LISTEN_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.1.16:2379&quot;</span>

<span class="token comment">#[Clustering]</span>
<span class="token assign-left variable">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.1.16:2380&quot;</span>
<span class="token assign-left variable">ETCD_ADVERTISE_CLIENT_URLS</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.1.16:2379&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER</span><span class="token operator">=</span><span class="token string">&quot;etcd01=https://192.168.1.5:2380,etcd02=https://192.168.1.9:2380,etcd03=https://192.168.1.16:2380&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="token operator">=</span><span class="token string">&quot;etcd-cluster&quot;</span>
<span class="token assign-left variable">ETCD_INITIAL_CLUSTER_STATE</span><span class="token operator">=</span><span class="token string">&quot;new&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><ul><li><p>验证集群是否正常运行（在master上操作）</p> <p>执行：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master bin<span class="token punctuation">]</span><span class="token comment"># ./etcdctl --ca-file=/k8s/etcd/ssl/ca.pem --cert-file=/k8s/etcd/ssl/server.pem --key-file=/k8s/etcd/ssl/server-key.pem --endpoints=&quot;https://192.168.1.5:2379,\</span>
https://192.168.1.9:2379,<span class="token punctuation">\</span>
https://192.168.1.16:2379&quot; cluster-health
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>结果：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>member 2b5e1efdc00a764e is healthy: got healthy result from https://192.168.1.9:2379
member 97797244e0f60935 is healthy: got healthy result from https://192.168.1.5:2379
member d8e778c20ef8bd26 is healthy: got healthy result from https://192.168.1.16:2379
cluster is healthy
<span class="token comment">#注意：启动节点失败将/var/lib/etcd的东西删掉</span>
<span class="token comment">#启动ETCD集群同时启动二个节点，启动一个节点集群是无法正常启动的；</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li></ul> <h3 id="部署flannel网络"><a href="#部署flannel网络" class="header-anchor">#</a> 部署Flannel网络</h3> <ul><li>向 etcd 写入集群 Pod 网段信息</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /k8s/etcd/ssl/
/k8s/etcd/bin/etcdctl <span class="token punctuation">\</span>
--ca-file<span class="token operator">=</span>ca.pem --cert-file<span class="token operator">=</span>server.pem <span class="token punctuation">\</span>
--key-file<span class="token operator">=</span>server-key.pem <span class="token punctuation">\</span>
--endpoints<span class="token operator">=</span><span class="token string">&quot;https://192.168.1.5:2379,\
https://192.168.1.9:2379,https://192.168.1.16:2379&quot;</span> <span class="token punctuation">\</span>
<span class="token builtin class-name">set</span> /coreos.com/network/config  <span class="token string">'{ &quot;Network&quot;: &quot;172.18.0.0/16&quot;, &quot;Backend&quot;: {&quot;Type&quot;: &quot;vxlan&quot;}}'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>解压安装flannel</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">tar</span> -zxvf flannel-v0.10.0-linux-amd64.tar.gz
<span class="token function">mv</span> flanneld mk-docker-opts.sh /k8s/kubernetes/bin/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>配置Flannel</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /k8s/kubernetes/cfg/flanneld

<span class="token assign-left variable">FLANNEL_OPTIONS</span><span class="token operator">=</span><span class="token string">&quot;--etcd-endpoints=https://192.168.1.5:2379,https://192.168.1.9:2379,https://192.168.1.16:2379 -etcd-cafile=/k8s/etcd/ssl/ca.pem -etcd-certfile=/k8s/etcd/ssl/server.pem -etcd-keyfile=/k8s/etcd/ssl/server-key.pem&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>创建 flanneld 的 systemd unit 文件</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /usr/lib/systemd/system/flanneld.service

<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Flanneld overlay address etcd agent
<span class="token assign-left variable">After</span><span class="token operator">=</span>network-online.target network.target
<span class="token assign-left variable">Before</span><span class="token operator">=</span>docker.service

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>notify
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>/k8s/kubernetes/cfg/flanneld
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/k8s/kubernetes/bin/flanneld --ip-masq <span class="token variable">$FLANNEL_OPTIONS</span>
<span class="token assign-left variable">ExecStartPost</span><span class="token operator">=</span>/k8s/kubernetes/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/subnet.env
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><blockquote><ul><li>mk-docker-opts.sh 脚本将分配给 flanneld 的 Pod 子网网段信息写入 /run/flannel/docker 文件，后续 docker 启动时 使用这个文件中的环境变量配置 docker0 网桥；</li> <li>flanneld 使用系统缺省路由所在的接口与其它节点通信，对于有多个网络接口（如内网和公网）的节点，可以用 -iface 参数指定通信接口，如上面的 eth0 接口;</li> <li>flanneld 运行时需要 root 权限；</li></ul></blockquote> <ul><li>配置Docker启动指定子网段</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /usr/lib/systemd/system/docker.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Docker Application Container Engine
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://docs.docker.com
<span class="token assign-left variable">After</span><span class="token operator">=</span>network-online.target firewalld.service
<span class="token assign-left variable">Wants</span><span class="token operator">=</span>network-online.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>notify
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>/run/flannel/subnet.env
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/bin/dockerd <span class="token variable">$DOCKER_NETWORK_OPTIONS</span>
<span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/bin/kill -s HUP <span class="token variable">$MAINPID</span>
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span>infinity
<span class="token assign-left variable">LimitNPROC</span><span class="token operator">=</span>infinity
<span class="token assign-left variable">LimitCORE</span><span class="token operator">=</span>infinity
<span class="token assign-left variable">TimeoutStartSec</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">Delegate</span><span class="token operator">=</span>yes
<span class="token assign-left variable">KillMode</span><span class="token operator">=</span>process
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">StartLimitBurst</span><span class="token operator">=</span><span class="token number">3</span>
<span class="token assign-left variable">StartLimitInterval</span><span class="token operator">=</span>60s

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><ul><li>将flanneld systemd unit 文件到所有节点</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /k8s/
<span class="token function">scp</span> -r kubernetes node1:/k8s/
<span class="token function">scp</span> -r kubernetes node2:/k8s/
<span class="token function">scp</span> /k8s/kubernetes/cfg/flanneld node1:/k8s/kubernetes/cfg/flanneld
<span class="token function">scp</span> /k8s/kubernetes/cfg/flanneld node2:/k8s/kubernetes/cfg/flanneld
<span class="token function">scp</span> /usr/lib/systemd/system/docker.service  node1:/usr/lib/systemd/system/docker.service
<span class="token function">scp</span> /usr/lib/systemd/system/docker.service  node2:/usr/lib/systemd/system/docker.service
<span class="token function">scp</span> /usr/lib/systemd/system/flanneld.service  node1:/usr/lib/systemd/system/flanneld.service
<span class="token function">scp</span> /usr/lib/systemd/system/flanneld.service node2:/usr/lib/systemd/system/flanneld.service

<span class="token comment">#启动服务（三个节点同时执行）</span>
systemctl daemon-reload
systemctl start flanneld
systemctl <span class="token builtin class-name">enable</span> flanneld
systemctl restart docker
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="部署master-节点"><a href="#部署master-节点" class="header-anchor">#</a> 部署Master 节点</h3> <p>安装kube-apiserver，kube-scheduler，kube-controller-manager</p> <h4 id="环境准备-2"><a href="#环境准备-2" class="header-anchor">#</a> 环境准备</h4> <ul><li>将二进制文件解压拷贝到master 节点</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">tar</span> -zxvf kubernetes-server-linux-amd64.tar.gz
<span class="token builtin class-name">cd</span> kubernetes/server/bin/
<span class="token function">cp</span> kube-scheduler kube-apiserver kube-controller-manager kubectl /k8s/kubernetes/bin/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>拷贝认证</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cp</span> *pem /k8s/kubernetes/ssl/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="部署-kube-apiserver-组件"><a href="#部署-kube-apiserver-组件" class="header-anchor">#</a> 部署 kube-apiserver 组件</h4> <ul><li>创建 TLS Bootstrapping Token</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">head</span> -c <span class="token number">16</span> /dev/urandom <span class="token operator">|</span> od -An -t x <span class="token operator">|</span> <span class="token function">tr</span> -d <span class="token string">' '</span>
8d38ad6d7df6b109901bac9d07aaaefe

<span class="token function">vim</span> /k8s/kubernetes/cfg/token.csv
8d38ad6d7df6b109901bac9d07aaaefe,kubelet-bootstrap,10001,<span class="token string">&quot;system:kubelet-bootstrap&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li><p>创建apiserver配置文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>vim /k8s/kubernetes/cfg/kube-apiserver

KUBE_APISERVER_OPTS=&quot;--logtostderr=true \
--v=4 \
--etcd-servers=https://192.168.1.5:2379,https://192.168.1.9:2379,https://192.168.1.16:2379 \
--bind-address=192.168.1.5 \
--secure-port=6443 \
--advertise-address=192.168.1.5 \
--allow-privileged=true \
--service-cluster-ip-range=10.0.0.0/24 \
--enable-admission-plugins=NamespaceLifecycle,LimitRanger,SecurityContextDeny,ServiceAccount,ResourceQuota,NodeRestriction \
--authorization-mode=RBAC,Node \
--enable-bootstrap-token-auth \
--token-auth-file=/k8s/kubernetes/cfg/token.csv \
--service-node-port-range=30000-50000 \
--tls-cert-file=/k8s/kubernetes/ssl/server.pem  \
--tls-private-key-file=/k8s/kubernetes/ssl/server-key.pem \
--client-ca-file=/k8s/kubernetes/ssl/ca.pem \
--service-account-key-file=/k8s/kubernetes/ssl/ca-key.pem \
--etcd-cafile=/k8s/etcd/ssl/ca.pem \
--etcd-certfile=/k8s/etcd/ssl/server.pem \
--etcd-keyfile=/k8s/etcd/ssl/server-key.pem&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>创建apiserver.sh</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>vim apiserver.sh
#!/bin/bash
MASTER_ADDRESS=${1:-&quot;192.168.1.195&quot;}
ETCD_SERVERS=${2:-&quot;http://127.0.0.1:2379&quot;}

cat &lt;&lt;EOF &gt;/opt/kubernetes/cfg/kube-apiserver

KUBE_APISERVER_OPTS=&quot;--logtostderr=true \\
--v=4 \\
--etcd-servers=${ETCD_SERVERS} \\
--insecure-bind-address=127.0.0.1 \\
--bind-address=${MASTER_ADDRESS} \\
--insecure-port=8080 \\
--secure-port=6443 \\
--advertise-address=${MASTER_ADDRESS} \\
--allow-privileged=true \\
--service-cluster-ip-range=10.10.10.0/24 \\
--admission-control=NamespaceLifecycle,LimitRanger,SecurityContextDeny,ServiceAccount,ResourceQuota,NodeRestriction \
--authorization-mode=RBAC,Node \\
--kubelet-https=true \\
--enable-bootstrap-token-auth \\
--token-auth-file=/k8s/kubernetes/cfg/token.csv \\
--service-node-port-range=30000-50000 \\
--tls-cert-file=/k8s/kubernetes/ssl/server.pem  \\
--tls-private-key-file=//k8s/kubernetes/ssl/server-key.pem \\
--client-ca-file=/k8s/kubernetes/ssl/ca.pem \\
--service-account-key-file=/k8s/kubernetes/ssl/ca-key.pem \\
--etcd-cafile=/k8s/etcd/ssl/ca.pem \\
--etcd-certfile=/k8s/etcd/ssl/server.pem \\
--etcd-keyfile=/k8s/etcd/ssl/server-key.pem&quot;

EOF

cat &lt;&lt;EOF &gt;/usr/lib/systemd/system/kube-apiserver.service
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes

[Service]
EnvironmentFile=-/opt/kubernetes/cfg/kube-apiserver
ExecStart=/opt/kubernetes/bin/kube-apiserver \$KUBE_APISERVER_OPTS
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>执行执行</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>./apiserver.sh  <span class="token number">192.168</span>.1.5 https://192.168.1.5:2379,https://192.168.1.9:2379,https://192.168.1.16:2379
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>启动</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> kube-apiserver
systemctl restart kube-apiserver
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>创建 kube-apiserver systemd unit 文件</p></li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /usr/lib/systemd/system/kube-apiserver.service

<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes API Server
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>-/k8s/kubernetes/cfg/kube-apiserver
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/k8s/kubernetes/bin/kube-apiserver <span class="token variable">$KUBE_APISERVER_OPTS</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>启动服务</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> kube-apiserver
systemctl start kube-apiserver
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>查看apiserver是否运行</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">ps</span> -ef <span class="token operator">|</span><span class="token function">grep</span> kube-apiserver
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="部署-kube-scheduler"><a href="#部署-kube-scheduler" class="header-anchor">#</a> 部署 kube-scheduler</h4> <ul><li>创建kube-scheduler配置文件</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span>  /k8s/kubernetes/cfg/kube-scheduler

<span class="token assign-left variable">KUBE_SCHEDULER_OPTS</span><span class="token operator">=</span><span class="token string">&quot;--logtostderr=true --v=4 --master=127.0.0.1:8080 --leader-elect&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><ul><li>–address：在 127.0.0.1:10251 端口接收 http /metrics 请求；kube-scheduler 目前还不支持接收 https 请求；</li> <li>–kubeconfig：指定 kubeconfig 文件路径，kube-scheduler 使用它连接和验证 kube-apiserver；</li> <li>–leader-elect=true：集群运行模式，启用选举功能；被选为 leader 的节点负责处理工作，其它节点为阻塞状态；</li></ul></blockquote> <ul><li>创建kube-scheduler systemd unit 文件</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /usr/lib/systemd/system/kube-scheduler.service

<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes Scheduler
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>-/k8s/kubernetes/cfg/kube-scheduler
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/k8s/kubernetes/bin/kube-scheduler <span class="token variable">$KUBE_SCHEDULER_OPTS</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>启动服务</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> kube-scheduler.service
systemctl start kube-scheduler.service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>查看kube-scheduler是否运行</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">ps</span> -ef <span class="token operator">|</span><span class="token function">grep</span> kube-scheduler
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="部署-kube-controller-manager"><a href="#部署-kube-controller-manager" class="header-anchor">#</a> 部署 kube-controller-manager</h4> <ul><li>创建kube-controller-manager配置文件</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /k8s/kubernetes/cfg/kube-controller-manager

<span class="token assign-left variable">KUBE_CONTROLLER_MANAGER_OPTS</span><span class="token operator">=</span><span class="token string">&quot;--logtostderr=true \
--v=4 \
--master=127.0.0.1:8080 \
--leader-elect=true \
--address=127.0.0.1 \
--service-cluster-ip-range=10.0.0.0/24 \
--cluster-name=kubernetes \
--cluster-signing-cert-file=/k8s/kubernetes/ssl/ca.pem \
--cluster-signing-key-file=/k8s/kubernetes/ssl/ca-key.pem  \
--root-ca-file=/k8s/kubernetes/ssl/ca.pem \
--service-account-private-key-file=/k8s/kubernetes/ssl/ca-key.pem&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>创建kube-controller-manager systemd unit 文件</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /usr/lib/systemd/system/kube-controller-manager.service

<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes Controller Manager
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/kubernetes/kubernetes

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>-/k8s/kubernetes/cfg/kube-controller-manager
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/k8s/kubernetes/bin/kube-controller-manager <span class="token variable">$KUBE_CONTROLLER_MANAGER_OPTS</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>启动服务</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> kube-controller-manager
systemctl restart kube-controller-manager
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>查看kube-controller-manager是否启动</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl status kube-controller-manager
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>将可执行文件路/k8s/kubernetes/ 添加到 PATH 变量中</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /etc/profile
<span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/k8s/kubernetes/bin:<span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token environment constant">$HOME</span>/bin
<span class="token builtin class-name">source</span> /etc/profile
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>查看master集群状态</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master bin<span class="token punctuation">]</span><span class="token comment"># kubectl get cs,nodes</span>

NAME                                 STATUS    MESSAGE             ERROR
componentstatus/scheduler            Healthy   ok
componentstatus/controller-manager   Healthy   ok
componentstatus/etcd-1               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>
componentstatus/etcd-0               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>
componentstatus/etcd-2               Healthy   <span class="token punctuation">{</span><span class="token string">&quot;health&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>

NAME                STATUS   ROLES    AGE     VERSION
node/192.168.1.16   Ready    node     3h42m   v1.13.1
node/192.168.1.5    Ready    master   3h50m   v1.13.1
node/192.168.1.9    Ready    node     3h50m   v1.13.1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="部署-node-节点"><a href="#部署-node-节点" class="header-anchor">#</a> 部署 node 节点</h3> <p>安装 kubelet,kube-proxy</p> <blockquote><ul><li>kublet 运行在每个 worker 节点上，接收 kube-apiserver 发送的请求，管理 Pod 容器，执行交互式命令，如exec、run、logs 等;</li> <li>kublet 启动时自动向 kube-apiserver 注册节点信息，内置的 cadvisor 统计和监控节点的资源使用情况;</li> <li>为确保安全，本文档只开启接收 https 请求的安全端口，对请求进行认证和授权，拒绝未授权的访问(如apiserver、heapster)。</li></ul></blockquote> <ul><li>将kubelet 二进制文件拷贝node节点</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#在master节点上执行</span>
<span class="token function">cp</span> kubelet kube-proxy /k8s/kubernetes/bin/
<span class="token function">scp</span> kubelet kube-proxy <span class="token number">192.168</span>.1.9:/k8s/kubernetes/bin/
<span class="token function">scp</span> kubelet kube-proxy <span class="token number">192.168</span>.1.16:/k8s/kubernetes/bin/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>创建 kubelet bootstrap kubeconfig 文件</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#在master节点上执行</span>
<span class="token comment">#注：将ca.pem，environment.sh，kube-proxy-key.pem，kube-proxy.pem四个文件放到一个目录下</span>
<span class="token function">vim</span>  environment.sh
<span class="token comment"># 创建kubelet bootstrapping kubeconfig</span>
<span class="token assign-left variable">BOOTSTRAP_TOKEN</span><span class="token operator">=</span>8d38ad6d7df6b109901bac9d07aaaefe
<span class="token assign-left variable">KUBE_APISERVER</span><span class="token operator">=</span><span class="token string">&quot;https://192.168.1.5:6443&quot;</span>
<span class="token comment"># 设置集群参数</span>
kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
  --certificate-authority<span class="token operator">=</span>./ca.pem <span class="token punctuation">\</span>
  --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
  --server<span class="token operator">=</span><span class="token variable">${KUBE_APISERVER}</span> <span class="token punctuation">\</span>
  --kubeconfig<span class="token operator">=</span>bootstrap.kubeconfig

<span class="token comment"># 设置客户端认证参数</span>
kubectl config set-credentials kubelet-bootstrap <span class="token punctuation">\</span>
  --token<span class="token operator">=</span><span class="token variable">${BOOTSTRAP_TOKEN}</span> <span class="token punctuation">\</span>
  --kubeconfig<span class="token operator">=</span>bootstrap.kubeconfig

<span class="token comment"># 设置上下文参数</span>
kubectl config set-context default <span class="token punctuation">\</span>
  --cluster<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
  --user<span class="token operator">=</span>kubelet-bootstrap <span class="token punctuation">\</span>
  --kubeconfig<span class="token operator">=</span>bootstrap.kubeconfig

<span class="token comment"># 设置默认上下文</span>
kubectl config use-context default --kubeconfig<span class="token operator">=</span>bootstrap.kubeconfig

<span class="token comment">#----------------------</span>

<span class="token comment"># 创建kube-proxy kubeconfig文件</span>

kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
  --certificate-authority<span class="token operator">=</span>./ca.pem <span class="token punctuation">\</span>
  --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
  --server<span class="token operator">=</span><span class="token variable">${KUBE_APISERVER}</span> <span class="token punctuation">\</span>
  --kubeconfig<span class="token operator">=</span>kube-proxy.kubeconfig

kubectl config set-credentials kube-proxy <span class="token punctuation">\</span>
  --client-certificate<span class="token operator">=</span>./kube-proxy.pem <span class="token punctuation">\</span>
  --client-key<span class="token operator">=</span>./kube-proxy-key.pem <span class="token punctuation">\</span>
  --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
  --kubeconfig<span class="token operator">=</span>kube-proxy.kubeconfig

kubectl config set-context default <span class="token punctuation">\</span>
  --cluster<span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
  --user<span class="token operator">=</span>kube-proxy <span class="token punctuation">\</span>
  --kubeconfig<span class="token operator">=</span>kube-proxy.kubeconfig

kubectl config use-context default --kubeconfig<span class="token operator">=</span>kube-proxy.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><ul><li>将bootstrap kubeconfig和kube-proxy.kubeconfig 文件拷贝到所有 nodes节点</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cp</span> bootstrap.kubeconfig kube-proxy.kubeconfig /k8s/kubernetes/cfg/
<span class="token function">scp</span> bootstrap.kubeconfig kube-proxy.kubeconfig node1:/k8s/kubernetes/cfg/
<span class="token function">scp</span> bootstrap.kubeconfig kube-proxy.kubeconfig node2:/k8s/kubernetes/cfg/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>创建kubelet 参数配置文件拷贝到所有 nodes节点</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#在master上操作</span>
<span class="token function">vim</span> /k8s/kubernetes/cfg/kubelet.config

kind: KubeletConfiguration
apiVersion: kubelet.config.k8s.io/v1beta1
address: <span class="token number">192.168</span>.1.5
port: <span class="token number">10250</span>
readOnlyPort: <span class="token number">10255</span>
cgroupDriver: cgroupfs
clusterDNS: <span class="token punctuation">[</span><span class="token string">&quot;10.0.0.2&quot;</span><span class="token punctuation">]</span>
clusterDomain: cluster.local.
failSwapOn: <span class="token boolean">false</span>
authentication:
  anonymous:
    enabled: <span class="token boolean">true</span>


<span class="token comment">#将参数配置文件拷贝到其他节点并且ip需要改成自己的ip</span>
<span class="token function">scp</span> /k8s/kubernetes/cfg/kubelet.config node1:/k8s/kubernetes/cfg/
<span class="token function">scp</span> /k8s/kubernetes/cfg/kubelet.config node2:/k8s/kubernetes/cfg/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><ul><li>创建kubelet配置文件</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#在master上操作</span>
<span class="token function">vim</span> /k8s/kubernetes/cfg/kubelet

<span class="token assign-left variable">KUBELET_OPTS</span><span class="token operator">=</span><span class="token string">&quot;--logtostderr=true \
--v=4 \
--hostname-override=192.168.1.5 \
--kubeconfig=/k8s/kubernetes/cfg/kubelet.kubeconfig \
--bootstrap-kubeconfig=/k8s/kubernetes/cfg/bootstrap.kubeconfig \
--config=/k8s/kubernetes/cfg/kubelet.config \
--cert-dir=/k8s/kubernetes/ssl \
--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64:3.0&quot;</span>

<span class="token comment">#将文件拷贝到其他节点上并修改对应的ip</span>
<span class="token function">scp</span> /k8s/kubernetes/cfg/kubelet node1:/k8s/kubernetes/cfg/kubelet
<span class="token function">scp</span> /k8s/kubernetes/cfg/kubelet node2:/k8s/kubernetes/cfg/kubelet
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><ul><li>创建kubelet systemd unit 文件</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#在master上操作</span>
<span class="token function">vim</span> /usr/lib/systemd/system/kubelet.service

<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes Kubelet
<span class="token assign-left variable">After</span><span class="token operator">=</span>docker.service
<span class="token assign-left variable">Requires</span><span class="token operator">=</span>docker.service

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>/k8s/kubernetes/cfg/kubelet
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/k8s/kubernetes/bin/kubelet <span class="token variable">$KUBELET_OPTS</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure
<span class="token assign-left variable">KillMode</span><span class="token operator">=</span>process

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target

<span class="token comment">#将文件拷贝到其他节点上</span>
<span class="token function">scp</span> /usr/lib/systemd/system/kubelet.service node1:/usr/lib/systemd/system/kubelet.service
<span class="token function">scp</span> /usr/lib/systemd/system/kubelet.service node2:/usr/lib/systemd/system/kubelet.service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><ul><li>将kubelet-bootstrap用户绑定到系统集群角色</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#master节点上执行</span>
kubectl create clusterrolebinding kubelet-bootstrap <span class="token punctuation">\</span>
  --clusterrole<span class="token operator">=</span>system:node-bootstrapper <span class="token punctuation">\</span>
  --user<span class="token operator">=</span>kubelet-bootstrap
<span class="token comment">#clusterrolebinding.rbac.authorization.k8s.io/kubelet-bootstrap created</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>启动服务</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#在两个节点上执行</span>
systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> kubelet
systemctl restart kubelet
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>查看 CSR 列表</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl get csr

NAME                                                   AGE   REQUESTOR           CONDITION
node-csr-HjaojHavfm-vFzime9FfPUB4rNCuBAgUiUR8GrjaKeM   10m   kubelet-bootstrap   Pending
node-csr-bfl0GRKg5hWleaClBFAcXVvNOvNhRUJ0f11J3vNN9rY   10m   kubelet-bootstrap   Pending
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>手动 approve CSR 请求</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl certificate approve node-csr-HjaojHavfm-vFzime9FfPUB4rNCuBAgUiUR8GrjaKeM
kubectl certificate approve node-csr-bfl0GRKg5hWleaClBFAcXVvNOvNhRUJ0f11J3vNN9rY
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>查看集群状态</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl get nodes
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="部署-kebue-proxy"><a href="#部署-kebue-proxy" class="header-anchor">#</a> 部署 kebue-proxy</h3> <ul><li>创建 kube-proxy文件</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /k8s/kubernetes/cfg/kube-proxy
<span class="token assign-left variable">KUBE_PROXY_OPTS</span><span class="token operator">=</span><span class="token string">&quot;--logtostderr=true \
--v=4 \
--hostname-override=192.168.1.5 \
--cluster-cidr=10.0.0.0/24 \
--kubeconfig=/k8s/kubernetes/cfg/kube-proxy.kubeconfig&quot;</span>

<span class="token comment">#文件拷贝并且ip要改成自己的ip</span>
<span class="token function">scp</span> /k8s/kubernetes/cfg/kube-proxy node1:/k8s/kubernetes/cfg/
<span class="token function">scp</span> /k8s/kubernetes/cfg/kube-proxy node2:/k8s/kubernetes/cfg/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li>创建kube-proxy systemd unit 文件</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /usr/lib/systemd/system/kube-proxy.service

<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Kubernetes Proxy
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>-/k8s/kubernetes/cfg/kube-proxy
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/k8s/kubernetes/bin/kube-proxy <span class="token variable">$KUBE_PROXY_OPTS</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target


<span class="token comment">#文件拷贝</span>
<span class="token function">scp</span> /usr/lib/systemd/system/kube-proxy.service node1:/usr/lib/systemd/system/
<span class="token function">scp</span> /usr/lib/systemd/system/kube-proxy.service node2:/usr/lib/systemd/system/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><ul><li>启动服务</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> kube-proxy
systemctl restart kube-proxy
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>打node 或者master 节点的标签</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl label node <span class="token number">192.168</span>.1.5  node-role.kubernetes.io/master<span class="token operator">=</span><span class="token string">'master'</span>
kubectl label node <span class="token number">192.168</span>.1.9  node-role.kubernetes.io/node<span class="token operator">=</span><span class="token string">'node'</span>
kubectl label node <span class="token number">192.168</span>.1.16  node-role.kubernetes.io/node<span class="token operator">=</span><span class="token string">'node'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/blogs/2020/k8s/k8s_install.html#机器规划" class="sidebar-link reco-side-机器规划" data-v-70334359>机器规划</a></li><li class="level-2" data-v-70334359><a href="/blogs/2020/k8s/k8s_install.html#环境准备" class="sidebar-link reco-side-环境准备" data-v-70334359>环境准备</a></li><li class="level-2" data-v-70334359><a href="/blogs/2020/k8s/k8s_install.html#安装kubernetes" class="sidebar-link reco-side-安装kubernetes" data-v-70334359>安装kubernetes</a></li><li class="level-3" data-v-70334359><a href="/blogs/2020/k8s/k8s_install.html#安装及配置cfssl" class="sidebar-link reco-side-安装及配置cfssl" data-v-70334359>安装及配置CFSSL</a></li><li class="level-3" data-v-70334359><a href="/blogs/2020/k8s/k8s_install.html#创建认证证书" class="sidebar-link reco-side-创建认证证书" data-v-70334359>创建认证证书:</a></li><li class="level-3" data-v-70334359><a href="/blogs/2020/k8s/k8s_install.html#部署etcd" class="sidebar-link reco-side-部署etcd" data-v-70334359>部署ETCD</a></li><li class="level-3" data-v-70334359><a href="/blogs/2020/k8s/k8s_install.html#部署flannel网络" class="sidebar-link reco-side-部署flannel网络" data-v-70334359>部署Flannel网络</a></li><li class="level-3" data-v-70334359><a href="/blogs/2020/k8s/k8s_install.html#部署master-节点" class="sidebar-link reco-side-部署master-节点" data-v-70334359>部署Master 节点</a></li><li class="level-3" data-v-70334359><a href="/blogs/2020/k8s/k8s_install.html#部署-node-节点" class="sidebar-link reco-side-部署-node-节点" data-v-70334359>部署 node 节点</a></li><li class="level-3" data-v-70334359><a href="/blogs/2020/k8s/k8s_install.html#部署-kebue-proxy" class="sidebar-link reco-side-部署-kebue-proxy" data-v-70334359>部署 kebue-proxy</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.26b7b206.js" defer></script><script src="/assets/js/4.34a1f699.js" defer></script><script src="/assets/js/1.fa01cbc2.js" defer></script><script src="/assets/js/50.ce1e315b.js" defer></script>
  </body>
</html>
